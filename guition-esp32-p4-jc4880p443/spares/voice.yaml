# Migated over from an old template.

voice_assistant:
  microphone: esp32_microphone
  media_player: speaker_media_player
  micro_wake_word: my_wake_word
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  conversation_timeout: 300s
  on_end:
    # Wait a short amount of time to see if an announcement starts
    - wait_until:
        condition:
          - media_player.is_announcing:
        timeout: 1.5s
    # Announcement is finished and the I2S bus is free
    - wait_until:
        - and:
            - not:
                media_player.is_announcing:
            - not:
                media_player.is_playing:
    # Unmute the speakers once the assistant has finished
    - homeassistant.action:
        action: media_player.volume_mute
        data:
          entity_id: media_player.speakers
          is_volume_muted: "false"
    - micro_wake_word.start:
  on_client_connected:
    - micro_wake_word.start:
  on_client_disconnected:
    - micro_wake_word.stop:
  
micro_wake_word:
  id: my_wake_word
  models:
    - model: alexa
  on_wake_word_detected:
    then:
      - logger.log: "Wake word detected"
      # Mute the speakers so it doesn't interfere with the assistant's audio
      - homeassistant.action:
          action: media_player.volume_mute
          data:
            entity_id: media_player.speakers
            is_volume_muted: "true"
      - voice_assistant.start:
          wake_word: !lambda return wake_word;